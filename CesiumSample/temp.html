<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>示例名称</title>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
  />
  <meta name="description" content="示例简要描述"/>
  <script type="text/javascript" src="js/Sandcastle-header.js"></script>
  <script src="js/dat.gui-0.6.5/dat.gui.min.js"></script>
  <script src="js/config.samplesdata.js"></script>
  <script type="module" src="./js/load-cesium-es6.js"></script>
  <link rel="stylesheet" href="css/bucket.css"/>
  <link rel="stylesheet" href="css/demo.css"/>
  <script src="js/CesiumXPlugin.js"></script>
  <script src="js/satellite.js"></script>

</head>
<body class="sandcastle-loading">
<div id="geniusContainer" class="fullSize"></div>
<div id="loadingOverlay"><h1>正在加载...</h1></div>
<div id="toolbar">
</div>
<div id="tips">
  全球卫星运动数据
</div>
<script>
  function startup(Cesium) {
    'use strict';
    Cesium.Ion.defaultAccessToken = `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3MzAxMTQwMC1jYzMzLTQyYjMtOWIwYi03OTlkODMxMWY3OTMiLCJpZCI6NDg3OCwiaWF0IjoxNjU3NzA0MjcxfQ.Z5zUcdtKlHIeKKvqrpL4qQn2bu2pveOAdeS_oyFa3yY`;

    const clock = new Cesium.Clock({
      startTime : Cesium.JulianDate.fromIso8601("2022-07-11T00:00:00Z"),
      stopTime : Cesium.JulianDate.fromIso8601("2022-07-11T24:00:00Z"),
      currentTime : Cesium.JulianDate.fromIso8601("2022-07-11T10:00:00Z"),
      clockRange : Cesium.ClockRange.LOOP_STOP,
      clockStep : Cesium.ClockStep.SYSTEM_CLOCK_MULTIPLIER,
      multiplier : 1200,
      shouldAnimate : true,
    });
    const viewer = new Cesium.Viewer("geniusContainer", {
      clockViewModel : new Cesium.ClockViewModel(clock),
      terrainProvider : new Cesium.EllipsoidTerrainProvider(),
      imageryProvider : new Cesium.SingleTileImageryProvider({
        url : sampleData.image.bluemarble
      }),
      clockStep : Cesium.ClockRange.LOOP_STOP,
      useDefaultRenderLoop : true,
      skyBox : new Cesium.SkyBox({
        sources : {
          positiveX : sampleData.skybox.celestrak.px,
          positiveY : sampleData.skybox.celestrak.py,
          positiveZ : sampleData.skybox.celestrak.pz,
          negativeX : sampleData.skybox.celestrak.nx,
          negativeY : sampleData.skybox.celestrak.ny,
          negativeZ : sampleData.skybox.celestrak.nz,
        },
      }),
      targetFrameRate : 60,
      showRenderLoopErrors : true,
      requestRenderMode : true,
      timeline : true,
      animation : true
    });
    window.viewer = viewer;
    document.getElementById("Coor").style.bottom = "32px"; // 鼠标状态栏上调
    const nightLightImageryLayer = viewer.imageryLayers.addImageryProvider(
      new Cesium.IonImageryProvider({assetId : 3812})
    );
    nightLightImageryLayer.dayAlpha = 0;
    const scene = viewer.scene;
    scene.backgroundColor = Cesium.Color.fromCssColorString("#0E1422");
    scene.globe.enableLighting = true;
    scene.globe.nightFadeOutDistance = 1e8;

    const dataSource = new Cesium.CustomDataSource();
    fetch(sampleData.tle.catalog)
      .then(resp => resp.text())
      .then(function(data) {
        const splited = data.split("\r\n");
        const lineCount = splited.length;
        const catalog = [];
        for (let i = 0; i < lineCount; i += 3) {
          const catalogName = splited[i].trim();
          if (catalogName === "" || i > 3000) {
            continue;
          }
          if (catalogName.indexOf("BEIDOU") === -1) {
            // continue;
          }
          catalog.push({
            name : catalogName.trim(),
            tleLine1 : splited[i + 1],
            tleLine2 : splited[i + 2],
          })
        }
        return catalog;
      })
      .then(function(catalog) {
        console.dir(catalog);
        const count = catalog.length;
        // let dynamicOffsetEpoch = Date.now(), staticOffset = 0, propRate = 1.0;

        // function propTime(dynamicOffsetEpoch, staticOffset, propRate) {
        //   const now = new Date();
        //   const dynamicPropOffset = now.getTime() - dynamicOffsetEpoch;
        //   now.setTime(dynamicOffsetEpoch + staticOffset + dynamicPropOffset * propRate);
        //   return now;
        // };
        // const nowDate = propTime(dynamicOffsetEpoch, staticOffset, propRate);
        // const nowJ = satellite.jday(nowDate.getUTCFullYear(), nowDate.getUTCMonth() + 1, nowDate.getUTCDate(), nowDate.getUTCHours(), nowDate.getUTCMinutes(), nowDate.getUTCSeconds()) +
        //              nowDate.getUTCMilliseconds() * 1.15741e-8; // days per millisecond
        //
        // const NUM_SEGS = 255;
        // const len = NUM_SEGS + 1;
        // const TAU = 2 * Math.PI;

        for (let i = 0; i < count; i++) {
          const sat = catalog[i];
          const satrec = satellite.twoline2satrec(sat.tleLine1, sat.tleLine2);

          const entity = new Cesium.Entity({
            name : sat.name,
            id : satrec.satnum,
            point : {
              color : Cesium.Color.WHITE,
              outlineColor : Cesium.Color.BLACK.withAlpha(0.3),
              outlineWidth : 1,
              pixelSize : 4,
              scaleByDistance : new Cesium.NearFarScalar(1, 1.4, 5e7, 0.4),
              translucencyByDistance : new Cesium.NearFarScalar(1, 1, 5e7, 0.78),
            },
            // path : {
            //   show : true,
            //   leadTime : 0,
            //   trailTime : 60,
            //   width : 10,
            //   resolution : 1,
            //   material : new Cesium.PolylineGlowMaterialProperty({
            //     glowPower : 0.3,
            //     taperPower : 0.3,
            //     color : Cesium.Color.PALEGOLDENROD,
            //   }),
            // },
          })
          entity.satrec = satrec;

          entity.position = new Cesium.CallbackProperty(function(julianDate, result) {
            if (!Cesium.defined(result)) {
              result = new Cesium.Cartesian3();
            }
            let tempDate = Cesium.JulianDate.toDate(julianDate);
            let positionAndVelocity = satellite.propagate(satrec, tempDate);
            let positionEci = positionAndVelocity.position;
            if (!Cesium.defined(positionEci)) {
              let velocityEci = positionAndVelocity.velocity;
              entity.show = false;
              return result;
            }
            let gmst = satellite.gstime(tempDate);
            let positionEcf = satellite.eciToEcf(positionEci, gmst);
            result = Cesium.Cartesian3.multiplyByScalar(positionEcf, 1000, result);
            return result;
          }, false);
          dataSource.entities.add(entity);
        }
        viewer.dataSources.add(dataSource);
      })
      .catch(function(error) {
        console.error(error);
        debugger;
      });

    let labelDescripPickedEntity = null, lastPickedEntity;
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    handler.setInputAction(function(event) {

      if (labelDescripPickedEntity) {
        dataSource.entities.suspendEvents();
        dataSource.entities.remove(labelDescripPickedEntity);
        dataSource.entities.resumeEvents();
        labelDescripPickedEntity = null;
      }
      if (lastPickedEntity) {
        lastPickedEntity.point.color = Cesium.Color.WHITE;
        lastPickedEntity.point.outlineColor = Cesium.Color.BLACK.withAlpha(0.3);
        lastPickedEntity.point.outlineWidth = 1;
        lastPickedEntity.point.pixelSize = 4;
        if (Cesium.defined(lastPickedEntity.polyline)) {
          lastPickedEntity.polyline.show = false;
        }
        lastPickedEntity = undefined;
      }

      const pickedObject = viewer.scene.pick(event.endPosition);
      if (!Cesium.defined(pickedObject)) {
        return;
      }
      if (pickedObject.id instanceof Cesium.Entity && Cesium.defined(pickedObject.id.point)) {
        lastPickedEntity = pickedObject.id;
        lastPickedEntity.point.pixelSize = 12;
        lastPickedEntity.point.color = Cesium.Color.RED;
        if (!Cesium.defined(lastPickedEntity.polyline)) {
          const nowDate = Cesium.JulianDate.toDate(viewer.clock.currentTime);
          const satrec = lastPickedEntity.satrec;
          const nowJ = satellite.jday(nowDate.getUTCFullYear(), nowDate.getUTCMonth() + 1, nowDate.getUTCDate(), nowDate.getUTCHours(), nowDate.getUTCMinutes(), nowDate.getUTCSeconds()) +
                       nowDate.getUTCMilliseconds() * 1.15741e-8; // days per millisecond

          let now = (nowJ - satrec.jdsatepoch) * 1440.0; // in minutes
          const NUM_SEGS = 255;
          const len = NUM_SEGS + 1;
          let period = (2 * Math.PI) / satrec.no; // convert rads/min to min
          let timeslice = period / NUM_SEGS;
          let linePositions = [];
          let j = 0;
          while (j < len) {
            j++;
            const t = now + j * timeslice;
            let p = satellite.sgp4(satrec, t)?.position;
            if (isNaN(p.x) || isNaN(p.y) || isNaN(p.z)) {
              continue;
            }
            linePositions.push(Cesium.Cartesian3.multiplyByScalar(p, 1000, new Cesium.Cartesian3()));
          }
          lastPickedEntity.polyline = new Cesium.PolylineGraphics({
            positions : linePositions
          });
        } else {
          lastPickedEntity.polyline.show = true;
        }

        labelDescripPickedEntity = new Cesium.Entity({
          position : lastPickedEntity.position.getValue(viewer.clock.currentTime),
          label : {
            text : `id:${lastPickedEntity.id}\n名称:${lastPickedEntity.name}`,
            showBackground : true,
            backgroundColor : Cesium.Color.WHITE,
            style : Cesium.LabelStyle.FILL_AND_OUTLINE,
            fillColor : Cesium.Color.RED,
            outlineColor : Cesium.Color.YELLOW,
            outlineWidth : 2,
            font : "18px sans-serif",
            horizontalOrigin : Cesium.HorizontalOrigin.LEFT,
            verticalOrigin : Cesium.VerticalOrigin.CENTER,
            showBorder : true,
            disableDepthTestDistance : Number.POSITIVE_INFINITY,
            scaleByDistance : new Cesium.NearFarScalar(1, 1, 5e7, 0.4),
          }
        });

        dataSource.entities.add(labelDescripPickedEntity);
        // viewer.flyTo(pickedEntity);
      }
      // }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

    const viewModel = {
      viewInECI : true
    }
    scene.postUpdate.addEventListener(function(scene, time) {
      if (viewModel.viewInECI) {
        return;
      }
      const icrfToFixed = Cesium.Transforms.computeIcrfToFixedMatrix(time);
      if (Cesium.defined(icrfToFixed)) {
        const camera = scene.camera;
        const offset = Cesium.Cartesian3.clone(camera.position),
          transform = Cesium.Matrix4.fromRotationTranslation(icrfToFixed);
        camera.lookAtTransform(transform, offset);
      }
    });

    const pannel = new dat.gui.GUI();
    pannel.width = 300;
    const paramControl = pannel.addFolder("参数设置");
    paramControl.add(viewModel, "viewInECI").name("ReferenceFrame.INERTIAL")
    Sandcastle.finishedLoading();
  }
</script>
</body>
</html>
